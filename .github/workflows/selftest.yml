name: Tests

on:
    pull_request

jobs:
    test:
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false
            matrix:
                os: [ # windows-latest ]
                  macos-13,
                  macos-latest,
                  ubuntu-22.04,
                  ubuntu-22.04-arm,
                  ubuntu-24.04,
                  ubuntu-24.04-arm,
                  windows-latest
                ]
                v : [^14, ""]
                soft: [true, false]

        steps:
            - name: Enable/disable softlinks support in git
              run: git config --global core.symlinks ${{ matrix.soft }}

            - name: Check out den
              uses: actions/checkout@v2

            - name: Clean up dev deps
              shell: bash
              run: rm -rf deps/*

            - name: Check out cstrings
              uses: actions/checkout@v2
              with:
                repository: mosteo/cstrings
                path: deps/cstrings

            - name: Verify same example
              shell: bash
              run: cmp example/src/example.adb tests/src/example.adb

            - name: Set up Alire
              uses: alire-project/setup-alire@v5
              with:
                  version: nightly
                  toolchain: gnat_native${{matrix.v}} gprbuild

            - name: Test
              shell: bash
              run: |
                  alr test
